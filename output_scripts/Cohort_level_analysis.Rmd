---
title: "Supplement:Network Hawkes Process Models for Exploring Latent Hierarchy in Social Animal Interactions"
author: 
date: '`r Sys.Date()`'
output:
  # html_document:
  #   # toc: true
  #   # toc_depth: 1
  #   number_sections: true
  #   # toc_float: true
  #   code_folding: hide
  pdf_document
---


Here we provide some summary analysis for each of the mice cohorts
used in this paper. We include analyses for each cohort 
separately, along with providing some further overall results.

```{r setup, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, fig.height = 5, fig.width = 7,
  warning = FALSE, cache = TRUE
)
# knitr::opts_chunk$set(echo = FALSE) ### for pdf output

## cache_options for individual output types here? maybe?
cache_table <- FALSE
cache_corr <- FALSE
cache_pars <- FALSE

# don't write to this path
data_path <- "../output/revisions/aug_run/"

options(digits = 3)

func_dir <- "../lib/"

library(here)
# library(rstan)
library(cmdstanr)
Sys.setenv(LOCAL_CPPFLAGS = "-march=corei7 -mtune=corei7")
options(mc.cores = parallel::detectCores())
library(tidyverse)
library(R.utils)
library(RColorBrewer)
library(fields)
library(posterior)
library(bayesplot)
library(viridis)
library(here)
library(corrplot)
library(compete)
library(kableExtra)
library(colorspace)
source(paste(func_dir, "naiveRankHierarchy.R", sep = ""))
source(paste(func_dir, "expertRankHierarchy.R", sep = ""))
source(paste(func_dir, "cleanData.R", sep = ""))
source(paste(func_dir, "prepareDataStan.R", sep = ""))
source(paste(func_dir, "inferLatentMmhp.R", sep = ""))
source(paste(func_dir, "plotUtil.R", sep = ""))
source(paste(func_dir, "mmhp.R", sep = ""))
source(paste(func_dir, "uniHawkes.R", sep = ""))
source(paste(func_dir, "simulatePrediction.R", sep = ""))
source(paste(func_dir, "myGlicko.R", sep = ""))
source(paste(func_dir, "matrixPlotParameter.R", sep = ""))
source(paste(func_dir, "residualStructureScore.R", sep = ""))
source(paste(func_dir, "drawIntensity.R", sep = ""))
source("https://gist.githubusercontent.com/jalapic/6ca3ece44bdcdc522bb735f183aa0ca0/raw/1a07f469eff08117121b6cbebcd22fb7569e3ee8/compete_extra.R")

cohort_names <- paste("cohort", c(9, 10, 12, 15, 16, 17, 18, 37, 38, 45),
                      sep = "")
cohort_short_names <- paste("C", c(9, 10, 12, 15, 16, 17, 18, 37, 38, 45),
                            sep = "")
cut_off <- 3
mice_number <- 12
col_df <- tibble(
  method = c(
    "I&SI", "AggRank", "DSNL", "Glicko", "I-MMHP",
    "C-HP", "C-DCHP", "True", "C-MMHP"
  ),
  cols = viridis(9)
)
theme_set(theme_minimal())
```

```{css, echo=FALSE, cache=FALSE}
.header-section-number {
  display: none;
}

body {
  counter-reset: counter-level-1;
}

h1:not(.title) {
  counter-increment: counter-level-1;
  counter-reset: counter-level-2;
}


h2 {
  counter-increment: counter-level-1;
  counter-increment: counter-level-2;
  # counter-reset: counter-level-3;
}

h2::before {
  counter-increment: counter-level-1;
}

h3 {
  counter-increment: counter-level-3;
  counter-increment: counter-level-2;
}


h3::before {
  content: counter(counter-level-2) " ";
}
```

```{r load rankings, echo=FALSE, results='hide'}
full_data <- readRDS("../data/mice.RData")
# A=c9, B=c10, C=c12, D=c15, E=c16, F=c17, G=c18, H=c37, I=c38. J=c45

# Define the cohorts will be fitted
fit_cohorts <- c(1:10)
naive_rank_10 <- list()
expert_rank_10 <- list()
out <- captureOutput(for (curr_cohort in fit_cohorts) {
  naive_rank_10[[curr_cohort]] <-
    naiveRankHierarchy(full_data[[cohort_names[curr_cohort]]])
  expert_rank_10[[curr_cohort]] <-
    expertRankHierarchy(full_data[[cohort_names[curr_cohort]]])
})
```

```{r define_functions}
model1_fn <- list(alpha.fun = function(x, y, eta1, eta2, eta3) {
  return(eta1 * x * y * exp(-eta2 * abs(x - y)) / (1 +
    exp(-eta3 * (x - y))))
})

model3_fn <- list(
  alpha.fun = function(x, y, eta1, eta2) {
    return(eta1 * x * y * exp(-eta2 * abs(x - y)))
  },
  q1.fun = function(x, y, eta3) {
    return(exp(-eta3 * x))
  },
  q0.fun = function(x, y, eta3) {
    return(exp(-eta3 * y))
  }
)
```


```{r define_plot_functions}
print_total_events <- function(current_cohort) {
  cat(paste("Cohort ", current_cohort, "\n", sep = ""))
  clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
  stan_input_lst <- prepareDataStan(current_cohort)
  
  pair_events <- apply(stan_input_lst$Nm, 1, sum)
  
  pair_matrix <- matrix(0, nrow = 12, ncol = 12)
  for(i in seq_along(pair_events)) {
    i_ind <- stan_input_lst$I_fit[i]
    j_ind <- stan_input_lst$J_fit[i]
    pair_matrix[i_ind, j_ind] <- pair_events[i]
  }
  # pair_matrix <- clean_data$N_count[expert_rank_10[[current_cohort]],
  #                                   expert_rank_10[[current_cohort]]]
  pair_matrix <- pair_matrix[expert_rank_10[[current_cohort]],
                    expert_rank_10[[current_cohort]]]
  colnames(pair_matrix) <- expert_rank_10[[current_cohort]]
  rownames(pair_matrix) <- expert_rank_10[[current_cohort]]
  print(pair_matrix)
}

total_events_active <- function(current_cohort) {
  clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
  return_df <- cleanObservationPeriod(current_cohort,
                                      raw_df =
                     full_data[[cohort_names[current_cohort]]],
                                      clean_data
  )
  unique_pairs_df <- return_df %>%
    group_by(initiator, recipient) %>%
    dplyr::summarize(
      count = n(),
      observe = list(observe.id),
      observe.length = list(observe.time),
      no.events = list(no.events)
    )
  unique_observe_win <- unique(return_df[,
                                         c("observe.id", "observe.time")])
  load(paste(data_path, cohort_names[current_cohort],
             "/cmmhp_est_zt_", cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  total_event_array <- array(0,
                             dim = c(mice_number, mice_number,
                                     max(return_df$observe.id)))
  active_event_array <- array(0,
                              dim = c(mice_number, mice_number,
                                      max(return_df$observe.id)))
  
  for (i in 1:mice_number) {
    for (j in 1:mice_number) {
      if(i != j) {
        pair <- which(unique_pairs_df$initiator == i &
                        unique_pairs_df$recipient == j)
        if (length(pair) > 0) {
          current_window_vec <- unique_pairs_df$observe[[pair]]
          for (cur_win in current_window_vec) {
            row_indicator <- (return_df$initiator == i) &
              (return_df$recipient == j) &
              (return_df$observe.id == cur_win)
            total_event_array[i, j, cur_win] <-
              length(return_df[
                row_indicator,"event.times"][[1]])
            active_event_array[i, j, cur_win] <- sum(apply(2 -
                        state_array_list[[pair]][[cur_win]],
                                                           1, mean) > 0.5)
          }
        }
      }
    }
  }
  
  total_matrix <- apply(total_event_array, c(1,2), sum)
  active_matrix <- apply(active_event_array, c(1,2), sum)
  rm(interpolation_array_list)
  rm(initial_state_list)
  rm(termination_state_list)
  rm(state_array_list)
  return(active_matrix)
}

print_total_less_windows <- function(current_cohort) {
  cat(paste("Cohort ", current_cohort, "\n", sep = ""))
  clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
  stan_input_lst <- prepareDataStan(current_cohort)
  
  pair_events <- apply(stan_input_lst$Nm, 1, sum) -
    rowSums(stan_input_lst$Nm != 0)
  
  pair_matrix <- matrix(0, nrow = 12, ncol = 12)
  for(i in seq_along(pair_events)) {
    i_ind <- stan_input_lst$I_fit[i]
    j_ind <- stan_input_lst$J_fit[i]
    pair_matrix[i_ind, j_ind] <- pair_events[i]
  }
  # pair_matrix <- clean_data$N_count[expert_rank_10[[current_cohort]],
  #                                   expert_rank_10[[current_cohort]]]
  pair_matrix <- pair_matrix[expert_rank_10[[current_cohort]],
                    expert_rank_10[[current_cohort]]]
  colnames(pair_matrix) <- expert_rank_10[[current_cohort]]
  rownames(pair_matrix) <- expert_rank_10[[current_cohort]]
  print(pair_matrix)
}

rankings_by_total <- function(current_cohort) {
  clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
             ))
  load(paste(data_path, cohort_names[current_cohort],
    "/agg_rank_stan_result_", cohort_names[current_cohort],
    ".RData",
    sep = ""
  ))
  load(paste(data_path, cohort_names[current_cohort],
    "/cohort_hp_stan_result_", cohort_names[current_cohort],
    ".RData",
    sep = ""
  ))
  load(paste(data_path, cohort_names[current_cohort],
    "/cohort_dchp_stan_result_", cohort_names[current_cohort],
    ".RData",
    sep = ""
  ))
  total_inter <- rowSums(clean_data$N_count) + colSums(clean_data$N_count)


  no_method <- 4
  plot_latent_df <- data.frame(
    Methods = rep(1:no_method, each = 1000 * mice_number),
    Mice = rep(rep(1:mice_number, each = 1000), no_method),
    force = rep(0, 1000 * mice_number * no_method)
  )
  ## agg
  x_draws <- sim_agg_rank %>% select(starts_with("x"))
  plot_latent_df$force[(1:(1000 * mice_number))] <-
    as.vector(as.matrix(x_draws))

  ## M1
  f_draws <- sim_cohort_hp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) +
                         1000 * mice_number] <-
    as.vector(as.matrix(f_draws))

  ## M2
  f_draws <- sim_cohort_dchp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) +
                         2000 * mice_number] <-
    as.vector(as.matrix(f_draws))

  ## M3
  f_draws <- sim_cohort_mmhp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) +
                         3000 * mice_number] <-
    as.vector(as.matrix(f_draws))

  plot_latent_df$Mice <- factor(plot_latent_df$Mice,
    levels = order(total_inter, decreasing = TRUE)
  )
  plot_latent_df$Method <- factor(plot_latent_df$Method,
    labels = c("AggRanking", "C-HP", "C-DCHP", "C-MMHP")
  )
  plot_cols <- col_df %>%
  filter(method %in% c(
    "AggRank", "C-HP",
    "C-DCHP", "C-MMHP"
  )) %>%
  pull(cols)


  p1 <- ggplot(plot_latent_df, aes(x = Mice, y = force, fill = Method)) +
    geom_boxplot(alpha = 0.7) +
    scale_fill_manual(values = plot_cols) +
    ggtitle("(a)") +
    theme_bw() +
    theme(
      plot.title = element_text(size = 22, hjust = 0.5, face = "bold"),
      text = element_text(size = 20),
      axis.text.x = element_text(size = 10),
      legend.position = "none"
    ) +
    facet_grid(cols = vars(Method)) +
    xlab("Mice (ranked by total interactions)") +
    ylab("Latent rank") +
    labs(title = paste("Cohort ", current_cohort, sep = ""))
  print(p1)
}

rankings_by_isi <- function(current_cohort){
  clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
             ))
  load(paste(data_path, cohort_names[current_cohort],
    "/agg_rank_stan_result_", cohort_names[current_cohort],
    ".RData",
    sep = ""
  ))
  load(paste(data_path, cohort_names[current_cohort],
    "/cohort_hp_stan_result_", cohort_names[current_cohort],
    ".RData",
    sep = ""
  ))
  load(paste(data_path, cohort_names[current_cohort],
    "/cohort_dchp_stan_result_", cohort_names[current_cohort],
    ".RData",
    sep = ""
  ))
  total_inter <- rowSums(clean_data$N_count) + colSums(clean_data$N_count)


  no_method <- 4
  plot_latent_df <- data.frame(
    Methods = rep(1:no_method, each = 1000 * mice_number),
    Mice = rep(rep(1:mice_number, each = 1000), no_method),
    force = rep(0, 1000 * mice_number * no_method)
  )
  ## agg
  x_draws <- sim_agg_rank %>% select(starts_with("x"))
  plot_latent_df$force[(1:(1000 * mice_number))] <-
    as.vector(as.matrix(x_draws))

  ## M1
  f_draws <- sim_cohort_hp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) +
                         1000 * mice_number] <-
    as.vector(as.matrix(f_draws))

  ## M2
  f_draws <- sim_cohort_dchp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) +
                         2000 * mice_number] <-
    as.vector(as.matrix(f_draws))

  ## M3
  f_draws <- sim_cohort_mmhp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) +
                         3000 * mice_number] <-
    as.vector(as.matrix(f_draws))

  plot_latent_df$Mice <- factor(plot_latent_df$Mice,
    levels = expert_rank_10[[current_cohort]]
  )
  plot_latent_df$Method <- factor(plot_latent_df$Method,
    labels = c("AggRanking", "C-HP", "C-DCHP", "C-MMHP")
  )
  plot_cols <- col_df %>%
  filter(method %in% c(
    "AggRank", "C-HP",
    "C-DCHP", "C-MMHP"
  )) %>%
  pull(cols)


  p1 <- ggplot(plot_latent_df, aes(x = Mice, y = force, fill = Method)) +
    geom_boxplot(alpha = 0.7) +
    scale_fill_manual(values = plot_cols) +
    ggtitle("(a)") +
    theme_bw() +
    theme(
      plot.title = element_text(size = 22, hjust = 0.5, face = "bold"),
      text = element_text(size = 20),
      axis.text.x = element_text(size = 10),
      legend.position = "none"
    ) +
    facet_grid(cols = vars(Method)) +
    xlab("Mice (ranked by I&SI)") +
    ylab("Latent rank") +
    labs(title = paste("Cohort ", current_cohort, sep = ""))
  print(p1)
}

rankings_by_cmmhp <- function(current_cohort) {
  clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  load(paste(data_path, cohort_names[current_cohort],
             "/agg_rank_stan_result_", cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  load(paste(data_path, cohort_names[current_cohort],
             "/cohort_hp_stan_result_", cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  load(paste(data_path, cohort_names[current_cohort],
             "/cohort_dchp_stan_result_", cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  total_inter <- rowSums(clean_data$N_count) + colSums(clean_data$N_count)
  
  
  no_method <- 4
  plot_latent_df <- data.frame(
    Methods = rep(1:no_method, each = 1000 * mice_number),
    Mice = rep(rep(1:mice_number, each = 1000), no_method),
    force = rep(0, 1000 * mice_number * no_method)
  )
  ## agg
  x_draws <- sim_agg_rank %>% select(starts_with("x"))
  plot_latent_df$force[(1:(1000 * mice_number))] <-
    as.vector(as.matrix(x_draws))
  
  ## M1
  f_draws <- sim_cohort_hp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) +
                         1000 * mice_number] <-
    as.vector(as.matrix(f_draws))
  
  ## M2
  f_draws <- sim_cohort_dchp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) +
                         2000 * mice_number] <-
    as.vector(as.matrix(f_draws))
  
  ## M3
  f_draws <- sim_cohort_mmhp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) +
                         3000 * mice_number] <-
    as.vector(as.matrix(f_draws))
  
  ### get median from this
  cmmhp_rank <- f_draws %>% 
    pivot_longer(everything()) %>%
    group_by(name) %>%
    summarise(med_rank = median(value)) %>% 
    arrange(desc(med_rank)) %>% 
    pull(name)
  ## then just get the numbers
  m3_ranks <- str_extract(cmmhp_rank, pattern = "[:digit:]+")
  
  plot_latent_df$Mice <- factor(plot_latent_df$Mice,
                                levels = m3_ranks
  )
  plot_latent_df$Method <- factor(plot_latent_df$Method,
                                  labels = c("AggRanking",
                                             "C-HP",
                                             "C-DCHP",
                                             "C-MMHP")
  )
  plot_cols <- col_df %>%
    filter(method %in% c(
      "AggRank", "C-HP",
      "C-DCHP", "C-MMHP"
    )) %>%
    pull(cols)
  p1 <- ggplot(plot_latent_df, aes(x = Mice, y = force, fill = Method)) +
    geom_boxplot(alpha = 0.7) +
    scale_fill_manual(values = plot_cols) +
    ggtitle("(a)") +
    theme_bw() +
    theme(
      plot.title = element_text(size = 22, hjust = 0.5, face = "bold"),
      text = element_text(size = 20),
      axis.text.x = element_text(size = 10),
      legend.position = "none"
    ) +
    facet_grid(cols = vars(Method)) +
    xlab("Mice (ranked by C-MMHP)") +
    ylab("Latent rank") +
    labs(title = paste("Cohort ", current_cohort, sep = ""))
  print(p1)
}

param_ests <- function(current_cohort){
  load(paste(data_path, cohort_names[current_cohort],
             "/cohort_hp_stan_result_", cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  load(paste(data_path, cohort_names[current_cohort],
             "/cohort_dchp_stan_result_", cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  plot_cols <- col_df %>%
    filter(method %in% c(
      "C-HP",
      "C-DCHP",
      "C-MMHP"
    )) %>%
    pull(cols)
  all_data <- sim_cohort_mmhp %>%
    select(starts_with("eta") | starts_with("w_lam") |
             starts_with("beta")) %>%
    select(! ends_with("delta")) %>% 
    pivot_longer(everything()) %>%
    mutate(Model = "C-MMHP") %>%
    bind_rows(sim_cohort_dchp %>%
                select(starts_with("eta") |
                         starts_with("w_lam") |
                         starts_with("beta")) %>%
                select(!ends_with("delta")) %>% 
                select(!ends_with("detla")) %>% 
                pivot_longer(everything()) %>%
                mutate(Model = "C-DCHP")) %>% 
    bind_rows(sim_cohort_hp %>%
                select(starts_with("eta") |
                         starts_with("w_lam") |
                         starts_with("beta")) %>%
                select(!ends_with("delta")) %>% 
                pivot_longer(everything()) %>%
                mutate(Model = "C-HP"))
  all_data$Model <- factor(all_data$Model,
                           levels = c("C-HP", "C-DCHP", "C-MMHP"))
  w_lam_est <- all_data %>% 
    filter(name == "w_lambda") %>% 
    summarise(median(value)) %>% pull()
  comp_plot <- ggplot(all_data, aes(name, value, fill = Model)) +
    geom_boxplot() +
    scale_fill_manual(values = plot_cols) +
    labs(title = paste("Cohort ", current_cohort, sep = ""),
         subtitle = "Estimated Model Parameters") +
    # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    theme(axis.text.x = element_blank()) +
    facet_wrap(~name, scales = "free")
  print(comp_plot)
  ###
  ## same for gamma
  all_data <- sim_cohort_mmhp %>%
    select(starts_with("gamma")) %>%
    pivot_longer(everything()) %>%
    mutate(Model = "C-MMHP",
           value = value * w_lam_est) %>%
    bind_rows(sim_cohort_dchp %>%
                select(starts_with("gamma")) %>%
                pivot_longer(everything()) %>%
                mutate(Model = "C-DCHP"))
  all_data$Model <- factor(all_data$Model,
                           levels = c("C-HP", "C-DCHP", "C-MMHP"))
  all_data$name <- factor(all_data$name, 
                          levels = paste0("gamma[",1:12,"]"))
  comp_plot <- ggplot(all_data, aes(name, value, fill = Model)) +
    geom_boxplot() +
    scale_fill_manual(values = plot_cols[2:3]) +
    labs(title = paste("Cohort ", current_cohort, sep = ""),
         subtitle = "Out Degree Parameters", y = "Out Degree") +
    theme(axis.text.x = element_blank()) +
    facet_wrap(~name, scales = "free")
  print(comp_plot)
  ###
  all_data <- sim_cohort_mmhp %>%
    select(starts_with("zeta") ) %>%
    pivot_longer(everything()) %>%
    mutate(Model = "C-MMHP",
           value = value * w_lam_est) %>%
    bind_rows(sim_cohort_dchp %>%
                select(starts_with("zeta")) %>%
                pivot_longer(everything()) %>%
                mutate(Model = "C-DCHP"))
  all_data$Model <- factor(all_data$Model,
                           levels = c("C-HP", "C-DCHP", "C-MMHP"))
  all_data$name <- factor(all_data$name, 
                          levels = paste0("zeta[",1:12,"]"))
  comp_plot <- ggplot(all_data, aes(name, value, fill = Model)) +
    geom_boxplot() +
    scale_fill_manual(values = plot_cols[2:3]) +
    labs(title = paste("Cohort ", current_cohort, sep = ""),
         subtitle = "In Degree Parameters", y = "In Degree") +
    facet_wrap(~name, scales = "free")
    # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  print(comp_plot)
}

fights_table <- function(current_cohort) {
  clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
  return_df <- cleanObservationPeriod(current_cohort,
                                      raw_df =
                                full_data[[cohort_names[current_cohort]]],
                                      clean_data
  )
  total_events <- clean_data$N_count
  active_events <- total_events_active(current_cohort)
  active_out <- rowSums(active_events)
  active_in <- colSums(active_events)
  out_fights <- rowSums(total_events)
  in_fights <- colSums(total_events)
  fight_data <- tibble(node = 1:12,
                       out_fights = out_fights,
                       in_fights = in_fights,
                       out_act_perc = active_out/out_fights,
                       in_act_perc = active_in/in_fights)
  
  isi_rank <- expert_rank_10[[current_cohort]]
  # this orders from best to worst
  ## load cmmhp rank
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  cmmhp_rank <- sim_cohort_mmhp %>% 
    select(starts_with("f")) %>% 
    pivot_longer(everything()) %>% 
    group_by(name) %>% 
    summarise(cmmhp_rank = median(value))
  out_degrees <- sim_cohort_mmhp %>% 
    select(starts_with("gamma")) %>% 
    pivot_longer(everything()) %>% 
    group_by(name) %>% 
    summarise(out_degree = median(value)) %>% 
    mutate(node = stringr::str_extract(name,
                                       pattern = "[:digit:]+")) %>%
    mutate(node = as.integer(node)) %>% 
    select(node, out_degree)
  in_degrees <- sim_cohort_mmhp %>% 
    select(starts_with("zeta")) %>% 
    pivot_longer(everything()) %>% 
    group_by(name) %>% 
    summarise(in_degree = median(value)) %>% 
    mutate(node = stringr::str_extract(name,
                                       pattern = "[:digit:]+")) %>% 
    mutate(node = as.integer(node)) %>% 
    select(node, in_degree)
  cmmhp_names <- stringr::str_extract(cmmhp_rank$name,
                                      pattern = "[:digit:]+")
  cmmhp_ranks <- tibble(node = cmmhp_names, 
                        rank = cmmhp_rank$cmmhp_rank) %>% 
    arrange(desc(rank)) %>% 
    mutate(node = as.integer(node), num_rank_cmmhp = 1:12)
  isi_ranks <- tibble(node = isi_rank, 
                      num_rank_isi = 1:length(cmmhp_names))
  ## don't need isi or cmmhp ranks here
  
  summary_data <- fight_data %>% 
    left_join(cmmhp_ranks, by = "node") %>% 
    left_join(isi_ranks, by = "node") %>% 
    left_join(out_degrees, by = "node") %>% 
    left_join(in_degrees, by = "node") %>% 
    # this will
    mutate(isi_less_cmmhp = num_rank_isi - num_rank_cmmhp) %>% 
    select(-c(rank,num_rank_isi, num_rank_cmmhp)) %>% 
    pivot_longer(cols = out_fights:isi_less_cmmhp)
  
  # knitr::kable(summary_data)
  summary_data
}

corr_matrices <- function(current_cohort) {
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  
  m3_ranks <- sim_cohort_mmhp %>% 
    select(starts_with("f")) %>% 
    pivot_longer(everything()) %>% 
    group_by(name) %>% 
    summarise("C-MMHP" = median(value))
  
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_hp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  
  m1_ranks <- sim_cohort_hp %>% 
    select(starts_with("f")) %>% 
    pivot_longer(everything()) %>% 
    group_by(name) %>% 
    summarise("C-HP" = median(value))
  
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_dchp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  
  m2_ranks <- sim_cohort_dchp %>% 
    select(starts_with("f")) %>% 
    pivot_longer(everything()) %>% 
    group_by(name) %>% 
    summarise("C-DCHP" = median(value))
  
  ranks <- m1_ranks %>% 
    left_join(m2_ranks, by = "name") %>% 
    left_join(m3_ranks, by = "name")
  
  cor_matrix <- cor(ranks[,2:4])
  # col3 = colorRampPalette(c('red', 'white', 'blue'))
  corrplot(cor_matrix,
           type = "upper",
           tl.col = "black",
           col.lim = c(0,1),
        title = "Pearson Correlation median ranks",
        mar = c(0, 0, 1, 0), diag = FALSE)
  
  ## same think for spearman rank correlation
  m1_num <- m1_ranks %>% 
    rename(value = "C-HP") %>% 
    arrange(desc(value)) %>% 
    mutate(chp = 1:12) %>% 
    mutate(node = stringr::str_extract(name,
                                       pattern = "[:digit:]+")) %>%
    mutate(node = as.integer(node)) %>% 
    select(node, chp)
  
  m2_num <- m2_ranks %>% 
    rename(value = "C-DCHP") %>% 
    arrange(desc(value)) %>% 
    mutate(cdchp = 1:12) %>% 
    mutate(node = stringr::str_extract(name,
                                       pattern = "[:digit:]+")) %>%
    mutate(node = as.integer(node)) %>% 
    select(node, cdchp)
  
  m3_num <- m3_ranks %>% 
    rename(value = "C-MMHP") %>% 
    arrange(desc(value)) %>% 
    mutate(cmmhp = 1:12) %>% 
    mutate(node = stringr::str_extract(name,
                                       pattern = "[:digit:]+")) %>%
    mutate(node = as.integer(node)) %>% 
    select(node, cmmhp)

  isi_ranks <- tibble(node = expert_rank_10[[current_cohort]],
                      isi = 1:12)
  ###
  rank_df <- m1_num %>% 
    left_join(m2_num, by = "node") %>% 
    left_join(m3_num, by = "node") %>% 
    left_join(isi_ranks, by = "node")

  spear_cor <- cor(rank_df[,2:5], method = "spearman")
  
  corrplot(spear_cor,
           type = "upper",
           tl.col = "black",
           col.lim = c(0,1),
           title = "Spearman Rank Correlation",
           mar = c(0, 0, 1, 0), diag = FALSE)
}

cohort_mae <- function(current_cohort) {
  load("../output/revisions/lapl_check/plot_N_predict_revision.RData")
  temp_plot_df <- predict_day_mae_df_lst[[current_cohort]]
  temp_plot_df$method <- factor(temp_plot_df$method,
    levels = c("mmhp", "dsnl", "m1", "m2", "m3"),
    labels = c("I-MMHP", "DSNL", "C-HP", "C-DCHP", "C-MMHP")
  )
  temp_plot_df$day <- factor(temp_plot_df$day)
  # png(paste(plot_path,"real_predict_N_one_cohort.png",sep=""),
  # width=600,height=300)
  
  plot_cols_pred <- col_df %>%
    filter(method %in% levels(temp_plot_df$method)) %>%
    arrange(factor(method, levels = c(
      "I-MMHP", "DSNL",
      "C-HP", "C-DCHP", "C-MMHP"
    ))) %>%
    pull(cols)
  
  p3 <- temp_plot_df %>%
    rowwise() %>%
    # mutate(norm = min(norm,60)) %>%
    # rename(Method = method) %>%
    ggplot(aes(x = method, y = mae, fill = method)) +
    geom_boxplot(alpha = 0.7) +
    scale_fill_manual(values = plot_cols_pred) +
    ggtitle("(a)") +
    theme_bw() +
    theme(
      plot.title = element_text(size = 22, hjust = 0.5, face = "bold"),
      text = element_text(size = 20),
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      legend.position = "right"
    ) +
    facet_grid(cols = vars(day)) +
    xlab("Prediction horizon (day)") +
    ylab("MAE") +
    ylim(0, 5) + # aren't infinite but >150 and <200
    NULL
  p3 + labs(fill = "Method", title = "Single Cohort",
            subtitle = paste("Cohort", current_cohort, sep = " "))
}

```



# Results {.tabset .unnumbered #sec1} 

## Cohort 1 {-}

```{r set_cohort}
current_cohort <- 1
clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
# the clean_data is handy for other intermediate analyses
```


### Total Events ordered by I&SI ranking

```{r total-events_1, message=FALSE}
print_total_events(current_cohort)
```

### Total Active Events ordered by I&SI

<!-- Here all events which are classified as inactive by the C-MMHP model -->
<!-- originate from the top ranked animal. As such there is strong -->
<!-- agreement between the win/loss matrix of all events and -->
<!-- those ocurring in active periods, with the  -->
<!-- restriction to only active events -->
<!-- slightly decreasing the  -->
<!-- influence of the top ranked animal. -->

```{r total-events-less-active-windows, message=FALSE}
active_events <- total_events_active(current_cohort)
active_events <- active_events[expert_rank_10[[current_cohort]],
                               expert_rank_10[[current_cohort]]]
colnames(active_events) <- expert_rank_10[[current_cohort]]
rownames(active_events) <- expert_rank_10[[current_cohort]]
print(active_events)
```


### Correlation Matrices

<!-- Examining the correlation matrices of both the median ranks for -->
<!-- each of our cohort models and the Spearman rank correlations, -->
<!-- we see that the C-HP most agrees with the I&SI ranking, -->
<!-- with the C-DCHP and C-MMHP models showing progressively less agreement. -->

```{r corr-plots, message=FALSE}
corr_matrices(current_cohort)
```


### Inferred ranking ordered by I&SI score

<!-- We next plot the inferred posterior rank estimates from  -->
<!-- each of our cohort models and the comparison AggRank model, -->
<!-- where we order the animals by the estimated I&SI ranking. -->

```{r ranked-by-isi}
rankings_by_isi(current_cohort)
```


### Inferred ranking order by C-MMHP median ranking

<!-- Similarly, to show how this rank differs from that obtained by the C-MMHP -->
<!-- model, we order the animals by the inferred ranking from that -->
<!-- model. -->

```{r ranked-by-cmmhp}
rankings_by_cmmhp(current_cohort)
```

### Parameter Estimates

<!-- For each of our three proposed models, we show the parameter -->
<!-- estimates for the non rank parameters, including the in and -->
<!-- out degree estimates for the models which incorporate degree -->
<!-- corrections. -->

```{r param-ests, message=FALSE}
param_ests(current_cohort)
```

### Summary Table

```{r summ_tabls, message=FALSE}
c1_summ <- fights_table(current_cohort)
# c1_summ %>% 
#   kbl() %>% 
#   kable_styling()

c1_summ %>% 
  pivot_wider(id_cols = node) %>% 
  rename(out_deg = out_degree, in_deg = in_degree,
         "Out Events" = out_fights,
         "In Events" = in_fights,
         "% In Active" = in_act_perc, "% Out Active" = out_act_perc,
         "Out Degree" = out_degree,
         "In Degree" = in_degree,
         "I&SI to C-MMHP change" = isi_less_cmmhp,
         "Animal" = node) %>% 
  kbl() %>% 
  kable_styling()
```

<!-- ### Cohort MAE -->

<!-- ```{r mae-cohort-1} -->
<!-- cohort_mae(current_cohort) -->
<!-- ``` -->

## Cohort 2 {-}

```{r set_cohort2}
current_cohort <- 2
```


### Total Events ordered by I&SI ranking

```{r total-events_2, message=FALSE}
print_total_events(current_cohort)
```

### Total Active Events ordered by I&SI

```{r total-events-less-active-windows2, message=FALSE}
active_events <- total_events_active(current_cohort)
active_events <- active_events[expert_rank_10[[current_cohort]],
                               expert_rank_10[[current_cohort]]]
colnames(active_events) <- expert_rank_10[[current_cohort]]
rownames(active_events) <- expert_rank_10[[current_cohort]]
print(active_events)
```


### Correlation Matrices


```{r corr-plots2, message=FALSE}
corr_matrices(current_cohort)
```


### Inferred ranking ordered by I&SI score

```{r ranked-by-isi2}
rankings_by_isi(current_cohort)
```


### Inferred ranking order by C-MMHP median ranking

```{r ranked-by-cmmhp2}
rankings_by_cmmhp(current_cohort)
```

### Parameter Estimates

```{r param-ests2, message=FALSE}
param_ests(current_cohort)
```

### Summary Table

```{r summ_tabls2, message=FALSE}
c2_summ <- fights_table(current_cohort)

c2_summ %>% 
  pivot_wider(id_cols = node) %>% 
  rename(out_deg = out_degree, in_deg = in_degree,
         "Out Events" = out_fights,
         "In Events" = in_fights,
         "% In Active" = in_act_perc, "% Out Active" = out_act_perc,
         "Out Degree" = out_degree,
         "In Degree" = in_degree,
         "I&SI to C-MMHP change" = isi_less_cmmhp,
         "Animal" = node) %>% 
  kbl() %>% 
  kable_styling()
```



## Cohort 3 {-}

```{r set_cohort3}
current_cohort <- 3
```


### Total Events ordered by I&SI ranking

```{r total-events_3, message=FALSE}
print_total_events(current_cohort)
```

### Total Active Events ordered by I&SI

```{r total-events-less-active-windows3, message=FALSE}
active_events <- total_events_active(current_cohort)
active_events <- active_events[expert_rank_10[[current_cohort]],
                               expert_rank_10[[current_cohort]]]
colnames(active_events) <- expert_rank_10[[current_cohort]]
rownames(active_events) <- expert_rank_10[[current_cohort]]
print(active_events)
```


### Correlation Matrices


```{r corr-plots3, message=FALSE}
corr_matrices(current_cohort)
```


### Inferred ranking ordered by I&SI score

```{r ranked-by-isi3}
rankings_by_isi(current_cohort)
```


### Inferred ranking order by C-MMHP median ranking

```{r ranked-by-cmmhp3}
rankings_by_cmmhp(current_cohort)
```

### Parameter Estimates

```{r param-ests3, message=FALSE}
param_ests(current_cohort)
```

### Summary Table

```{r summ_tabls3, message=FALSE}
c3_summ <- fights_table(current_cohort)

c3_summ %>% 
  pivot_wider(id_cols = node) %>% 
  rename(out_deg = out_degree, in_deg = in_degree,
         "Out Events" = out_fights,
         "In Events" = in_fights,
         "% In Active" = in_act_perc, "% Out Active" = out_act_perc,
         "Out Degree" = out_degree,
         "In Degree" = in_degree,
         "I&SI to C-MMHP change" = isi_less_cmmhp,
         "Animal" = node) %>% 
  kbl() %>% 
  kable_styling()
```



## Cohort 4 {-}

```{r set_cohort4}
current_cohort <- 4
```


### Total Events ordered by I&SI ranking

```{r total-events_4, message=FALSE}
print_total_events(current_cohort)
```

### Total Active Events ordered by I&SI

```{r total-events-less-active-windows4, message=FALSE}
active_events <- total_events_active(current_cohort)
active_events <- active_events[expert_rank_10[[current_cohort]],
                               expert_rank_10[[current_cohort]]]
colnames(active_events) <- expert_rank_10[[current_cohort]]
rownames(active_events) <- expert_rank_10[[current_cohort]]
print(active_events)
```


### Correlation Matrices


```{r corr-plots4, message=FALSE}
corr_matrices(current_cohort)
```


### Inferred ranking ordered by I&SI score

```{r ranked-by-isi4}
rankings_by_isi(current_cohort)
```


### Inferred ranking order by C-MMHP median ranking

```{r ranked-by-cmmhp4}
rankings_by_cmmhp(current_cohort)
```

### Parameter Estimates

```{r param-ests4, message=FALSE}
param_ests(current_cohort)
```

### Summary Table

```{r summ_tabls4, message=FALSE}
c4_summ <- fights_table(current_cohort)

c4_summ %>% 
  pivot_wider(id_cols = node) %>% 
  rename(out_deg = out_degree, in_deg = in_degree,
         "Out Events" = out_fights,
         "In Events" = in_fights,
         "% In Active" = in_act_perc, "% Out Active" = out_act_perc,
         "Out Degree" = out_degree,
         "In Degree" = in_degree,
         "I&SI to C-MMHP change" = isi_less_cmmhp,
         "Animal" = node) %>% 
  kbl() %>% 
  kable_styling()
```



## Cohort 5 {-}

```{r set_cohort5}
current_cohort <- 5
```


### Total Events ordered by I&SI ranking

```{r total-events_5, message=FALSE}
print_total_events(current_cohort)
```

### Total Active Events ordered by I&SI

```{r total-events-less-active-windows5, message=FALSE}
active_events <- total_events_active(current_cohort)
active_events <- active_events[expert_rank_10[[current_cohort]],
                               expert_rank_10[[current_cohort]]]

colnames(active_events) <- expert_rank_10[[current_cohort]]
rownames(active_events) <- expert_rank_10[[current_cohort]]
print(active_events)
```


### Correlation Matrices


```{r corr-plots5, message=FALSE}
corr_matrices(current_cohort)
```


### Inferred ranking ordered by I&SI score

```{r ranked-by-isi5}
rankings_by_isi(current_cohort)
```


### Inferred ranking order by C-MMHP median ranking

```{r ranked-by-cmmhp5}
rankings_by_cmmhp(current_cohort)
```

### Parameter Estimates

```{r param-ests5, message=FALSE}
param_ests(current_cohort)
```

### Summary Table

```{r summ_tabls5, message=FALSE}
c5_summ <- fights_table(current_cohort)

c5_summ %>% 
  pivot_wider(id_cols = node) %>% 
  rename(out_deg = out_degree, in_deg = in_degree,
         "Out Events" = out_fights,
         "In Events" = in_fights,
         "% In Active" = in_act_perc, "% Out Active" = out_act_perc,
         "Out Degree" = out_degree,
         "In Degree" = in_degree,
         "I&SI to C-MMHP change" = isi_less_cmmhp,
         "Animal" = node) %>% 
  kbl() %>% 
  kable_styling()
```



## Cohort 6 {-}

```{r set_cohort6}
current_cohort <- 6
```


### Total Events ordered by I&SI ranking

```{r total-events_6, message=FALSE}
print_total_events(current_cohort)
```

### Total Active Events ordered by I&SI

```{r total-events-less-active-windows6, message=FALSE}
active_events <- total_events_active(current_cohort)
active_events <- active_events[expert_rank_10[[current_cohort]],
                               expert_rank_10[[current_cohort]]]

colnames(active_events) <- expert_rank_10[[current_cohort]]
rownames(active_events) <- expert_rank_10[[current_cohort]]
print(active_events)
```


### Correlation Matrices


```{r corr-plots6, message=FALSE}
corr_matrices(current_cohort)
```


### Inferred ranking ordered by I&SI score

```{r ranked-by-isi6}
rankings_by_isi(current_cohort)
```


### Inferred ranking order by C-MMHP median ranking

```{r ranked-by-cmmhp6}
rankings_by_cmmhp(current_cohort)
```

### Parameter Estimates

```{r param-ests6, message=FALSE}
param_ests(current_cohort)
```

### Summary Table

```{r summ_tabls6, message=FALSE}
c6_summ <- fights_table(current_cohort)

c6_summ %>% 
  pivot_wider(id_cols = node) %>% 
  rename(out_deg = out_degree, in_deg = in_degree,
         "Out Events" = out_fights,
         "In Events" = in_fights,
         "% In Active" = in_act_perc, "% Out Active" = out_act_perc,
         "Out Degree" = out_degree,
         "In Degree" = in_degree,
         "I&SI to C-MMHP change" = isi_less_cmmhp,
         "Animal" = node) %>% 
  kbl() %>% 
  kable_styling()

```



## Cohort 7 {-}

```{r set_cohort7}
current_cohort <- 7
```


### Total Events ordered by I&SI ranking

```{r total-events_7, message=FALSE}
print_total_events(current_cohort)
```

### Total Active Events ordered by I&SI

```{r total-events-less-active-windows7, message=FALSE}
active_events <- total_events_active(current_cohort)
active_events <- active_events[expert_rank_10[[current_cohort]],
                               expert_rank_10[[current_cohort]]]

colnames(active_events) <- expert_rank_10[[current_cohort]]
rownames(active_events) <- expert_rank_10[[current_cohort]]
print(active_events)
```


### Correlation Matrices


```{r corr-plots7, message=FALSE}
corr_matrices(current_cohort)
```


### Inferred ranking ordered by I&SI score

```{r ranked-by-isi7}
rankings_by_isi(current_cohort)
```


### Inferred ranking order by C-MMHP median ranking

```{r ranked-by-cmmhp7}
rankings_by_cmmhp(current_cohort)
```

### Parameter Estimates

```{r param-ests7, message=FALSE}
param_ests(current_cohort)
```

### Summary Table

```{r summ_tabls7, message=FALSE}
c7_summ <- fights_table(current_cohort)
c7_summ %>% 
  pivot_wider(id_cols = node) %>% 
  rename(out_deg = out_degree, in_deg = in_degree,
         "Out Events" = out_fights,
         "In Events" = in_fights,
         "% In Active" = in_act_perc, "% Out Active" = out_act_perc,
         "Out Degree" = out_degree,
         "In Degree" = in_degree,
         "I&SI to C-MMHP change" = isi_less_cmmhp,
         "Animal" = node) %>% 
  kbl() %>% 
  kable_styling()
```



## Cohort 8 {-}

```{r set_cohort8}
current_cohort <- 8
```


### Total Events ordered by I&SI ranking

```{r total-events_8, message=FALSE}
print_total_events(current_cohort)
```

### Total Active Events ordered by I&SI

```{r total-events-less-active-windows8, message=FALSE}
active_events <- total_events_active(current_cohort)
active_events <- active_events[expert_rank_10[[current_cohort]],
                               expert_rank_10[[current_cohort]]]

colnames(active_events) <- expert_rank_10[[current_cohort]]
rownames(active_events) <- expert_rank_10[[current_cohort]]
print(active_events)
```


### Correlation Matrices


```{r corr-plots8, message=FALSE}
corr_matrices(current_cohort)
```


### Inferred ranking ordered by I&SI score

```{r ranked-by-isi8}
rankings_by_isi(current_cohort)
```


### Inferred ranking order by C-MMHP median ranking

```{r ranked-by-cmmhp8}
rankings_by_cmmhp(current_cohort)
```

### Parameter Estimates

```{r param-ests8, message=FALSE}
param_ests(current_cohort)
```

### Summary Table

```{r summ_tabls8, message=FALSE}
c8_summ <- fights_table(current_cohort)

c8_summ %>% 
  pivot_wider(id_cols = node) %>% 
  rename(out_deg = out_degree, in_deg = in_degree,
         "Out Events" = out_fights,
         "In Events" = in_fights,
         "% In Active" = in_act_perc, "% Out Active" = out_act_perc,
         "Out Degree" = out_degree,
         "In Degree" = in_degree,
         "I&SI to C-MMHP change" = isi_less_cmmhp,
         "Animal" = node) %>% 
  kbl() %>% 
  kable_styling()
```



## Cohort 9 {-}

```{r set_cohort9}
current_cohort <- 9
```


### Total Events ordered by I&SI ranking

```{r total-events_9, message=FALSE}
print_total_events(current_cohort)
```

### Total Active Events ordered by I&SI

```{r total-events-less-active-windows9, message=FALSE}
active_events <- total_events_active(current_cohort)
active_events <- active_events[expert_rank_10[[current_cohort]],
                               expert_rank_10[[current_cohort]]]

colnames(active_events) <- expert_rank_10[[current_cohort]]
rownames(active_events) <- expert_rank_10[[current_cohort]]
print(active_events)
```


### Correlation Matrices


```{r corr-plots9, message=FALSE}
corr_matrices(current_cohort)
```


### Inferred ranking ordered by I&SI score

```{r ranked-by-isi9}
rankings_by_isi(current_cohort)
```


### Inferred ranking order by C-MMHP median ranking

```{r ranked-by-cmmhp9}
rankings_by_cmmhp(current_cohort)
```

### Parameter Estimates

```{r param-ests9, message=FALSE}
param_ests(current_cohort)
```

### Summary Table

```{r summ_tabls9, message=FALSE}
c9_summ <-fights_table(current_cohort)

c9_summ %>% 
  pivot_wider(id_cols = node) %>% 
  rename(out_deg = out_degree, in_deg = in_degree,
         "Out Events" = out_fights,
         "In Events" = in_fights,
         "% In Active" = in_act_perc, "% Out Active" = out_act_perc,
         "Out Degree" = out_degree,
         "In Degree" = in_degree,
         "I&SI to C-MMHP change" = isi_less_cmmhp,
         "Animal" = node) %>% 
  kbl() %>% 
  kable_styling()
```



## Cohort 10 {-}

```{r set_cohort10}
current_cohort <- 10
```


### Total Events ordered by I&SI ranking

```{r total-events_10, message=FALSE}
print_total_events(current_cohort)
```

### Total Active Events ordered by I&SI

```{r total-events-less-active-windows10, message=FALSE}
active_events <- total_events_active(current_cohort)
active_events <- active_events[expert_rank_10[[current_cohort]],
                               expert_rank_10[[current_cohort]]]

colnames(active_events) <- expert_rank_10[[current_cohort]]
rownames(active_events) <- expert_rank_10[[current_cohort]]
print(active_events)
```


### Correlation Matrices


```{r corr-plots10, message=FALSE}
corr_matrices(current_cohort)
```


### Inferred ranking ordered by I&SI score

```{r ranked-by-isi10}
rankings_by_isi(current_cohort)
```


### Inferred ranking order by C-MMHP median ranking

```{r ranked-by-cmmhp10}
rankings_by_cmmhp(current_cohort)
```

### Parameter Estimates

```{r param-ests10, message=FALSE}
param_ests(current_cohort)
```

### Summary Table

```{r summ_tabls10, message=FALSE}
c10_summ <- fights_table(current_cohort)

c10_summ %>% 
  pivot_wider(id_cols = node) %>% 
  rename(out_deg = out_degree, in_deg = in_degree,
         "Out Events" = out_fights,
         "In Events" = in_fights,
         "% In Active" = in_act_perc, "% Out Active" = out_act_perc,
         "Out Degree" = out_degree,
         "In Degree" = in_degree,
         "I&SI to C-MMHP change" = isi_less_cmmhp,
         "Animal" = node) %>% 
  kbl() %>% 
  kable_styling()
```


## All Correlation Plots {-}

```{r all-corr-plots}
for(current_cohort in 1:10) {
  cat(paste("Cohort", current_cohort, "\n", sep = " "))
  cat("======== \n")
  corr_matrices(current_cohort)
}
```


## Summary Data {-}

### Degree Parameters

```{r get-all-cmmhp-degrees, message=FALSE}
cmmhp_gamma <- tibble()
cmmhp_zeta <- tibble()
out_perc <- tibble()
in_perc <- tibble()

### there is something up with the cohorts here, not correct!

for(current_cohort in 1:10) {
  ### get perc for each one here
  clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
  out_fights <- tibble(name = paste0("gamma[",1:12,"]"),
                       perc_out = rowSums(clean_data$N_count)/
                         sum(clean_data$N_count)) %>% 
    mutate(perc_out = round(perc_out, 2),
           cohort = paste0("Cohort_", current_cohort))
  in_fights <- tibble(name = paste0("zeta[",1:12,"]"),
                       perc_in = colSums(clean_data$N_count)/
                         sum(clean_data$N_count)) %>% 
    mutate(perc_in = round(perc_in, 2),
           cohort = paste0("Cohort_", current_cohort))
  ###
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  all_data <- sim_cohort_mmhp %>%
    select(starts_with("gamma") ) %>% 
    pivot_longer(everything()) %>%
    mutate(Model = "C-MMHP", cohort = paste0("Cohort_", current_cohort)) 
  out_perc <- out_perc %>% 
    bind_rows(out_fights)
  in_perc <- in_perc %>% 
    bind_rows(in_fights)
  cmmhp_gamma <- cmmhp_gamma %>% 
    bind_rows(all_data)
  all_data <- sim_cohort_mmhp %>%
    select(starts_with("zeta") ) %>% 
    pivot_longer(everything()) %>%
    mutate(Model = "C-MMHP", cohort = paste0("Cohort_", current_cohort)) 
  cmmhp_zeta <- cmmhp_zeta %>% 
    bind_rows(all_data)
}

###

cmmhp_gamma$name <- stringr::str_extract(cmmhp_gamma$name, 
                                         pattern = "[:digit:]+")
cmmhp_zeta$name <- stringr::str_extract(cmmhp_zeta$name, 
                                         pattern = "[:digit:]+")

out_perc$name <- stringr::str_extract(out_perc$name, 
                                         pattern = "[:digit:]+")
in_perc$name <- stringr::str_extract(in_perc$name, 
                                         pattern = "[:digit:]+")

out_perc$name <- factor(out_perc$name,
                           levels = as.character(1:12))
in_perc$name <- factor(in_perc$name,
                           levels = as.character(1:12))

out_perc$Model <- "C-MMHP"
in_perc$Model <- "C-MMHP"

max_out <- cmmhp_gamma %>% 
  group_by(name, cohort) %>% 
  summarise(max_est = max(value))

max_in <- cmmhp_zeta %>% 
  group_by(name, cohort) %>% 
  summarise(max_est = max(value))

out_perc <- out_perc %>% 
  left_join(max_out, by = c("name", "cohort"))

in_perc <- in_perc %>% 
  left_join(max_in, by = c("name", "cohort"))

cmmhp_gamma$name <- factor(cmmhp_gamma$name,
                           levels = as.character(1:12))
cmmhp_zeta$name <- factor(cmmhp_zeta$name,
                           levels = as.character(1:12))
# plot_cols
cmmhp_gamma$cohort <- factor(cmmhp_gamma$cohort, 
                             levels = paste0("Cohort_", 1:10))
cmmhp_zeta$cohort <- factor(cmmhp_zeta$cohort, 
                             levels = paste0("Cohort_", 1:10))
in_perc$cohort <- factor(in_perc$cohort, 
                        levels = paste0("Cohort_", 1:10))
out_perc$cohort <- factor(out_perc$cohort,
                         levels = paste0("Cohort_", 1:10))

cmmhp_gamma %>% 
  ggplot(aes(name, value, fill = Model)) +
  geom_boxplot() +
  scale_fill_manual(values = "#FDE725FF") +
  geom_text(data = out_perc, aes(name, 2 * max_est + 1.5, label = perc_out),
            size = 2) +
  # scale_y_continuous(breaks = 3) +
  facet_wrap(~cohort, scales = "free", ncol = 2) +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "Out Degree", x = element_blank(),
       subtitle = "Labels denote % total fights instigated")

cmmhp_zeta %>% 
  ggplot(aes(name, value, fill = Model)) +
  geom_boxplot() +
  scale_fill_manual(values = "#FDE725FF") +
  # scale_y_continuous(breaks = 3) +
  geom_text(data = in_perc, aes(name, 2 * max_est + 1.5, label = perc_in),
            size = 2) +
  facet_wrap(~cohort, scales = "free", ncol = 2) +
  # theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y = "In Degree", x = element_blank(),
       subtitle = "Labels denote % total fights received")

```

### Other Global Parameters

```{r plot-cohort-level-params}
cohort_pars <- tibble()
for(current_cohort in 1:10) {
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  all_data <- sim_cohort_mmhp %>%
    select(starts_with("eta") | starts_with("w_lam") |
             starts_with("beta")) %>%
    select(! ends_with("delta")) %>% 
    pivot_longer(everything()) %>%
    mutate(Model = "C-MMHP", cohort = paste0("C_", current_cohort))
  cohort_pars <- cohort_pars %>% 
    bind_rows(all_data)
}

cohort_pars$cohort <- factor(cohort_pars$cohort, 
                             levels = paste0("C_",1:10))

cohort_pars %>% 
  ggplot(aes(cohort, value, fill = Model)) +
  geom_boxplot() +
  scale_fill_manual(values = "#FDE725FF") +
  facet_wrap(~name, scales = "free") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```


### Cohort Summaries

```{r overall-fight-info, message=FALSE, warning=FALSE}
cohort_summ <- tibble()

for(current_cohort in 1:10) {
  clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
  total_events <- clean_data$N_count
  active_events <- total_events_active(current_cohort)
  total_fights <- sum(clean_data$N_count)
  coh_tbl <- tibble(cohort = current_cohort,
                    number_fights = total_fights,
                    act_perc = sum(active_events)/sum(total_fights))
  cohort_summ <- cohort_summ %>% 
    bind_rows(coh_tbl)
}

cohort_summ %>% 
  rename("Cohort" = cohort,
         "Total Fights" = number_fights,
         "% Active Fights" = act_perc) %>% 
  kbl() %>% 
  kable_styling()

```
### Relationship between active fights and difference in Spearman correlation

```{r plot_percent_active_vs_spear_corr}
# cohort_summ

spear_corr_all <- tibble()

for(current_cohort in 1:10) {
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  
  m3_ranks <- sim_cohort_mmhp %>% 
    select(starts_with("f")) %>% 
    pivot_longer(everything()) %>% 
    group_by(name) %>% 
    summarise("C-MMHP" = median(value))
  
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_hp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  
  m1_ranks <- sim_cohort_hp %>% 
    select(starts_with("f")) %>% 
    pivot_longer(everything()) %>% 
    group_by(name) %>% 
    summarise("C-HP" = median(value))
  
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_dchp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
  ))
  
  m2_ranks <- sim_cohort_dchp %>% 
    select(starts_with("f")) %>% 
    pivot_longer(everything()) %>% 
    group_by(name) %>% 
    summarise("C-DCHP" = median(value))
  
  ranks <- m1_ranks %>% 
    left_join(m2_ranks, by = "name") %>% 
    left_join(m3_ranks, by = "name")
  ## same think for spearman rank correlation
  m1_num <- m1_ranks %>% 
    rename(value = "C-HP") %>% 
    arrange(desc(value)) %>% 
    mutate(chp = 1:12) %>% 
    mutate(node = stringr::str_extract(name,
                                       pattern = "[:digit:]+")) %>%
    mutate(node = as.integer(node)) %>% 
    select(node, chp)
  
  m2_num <- m2_ranks %>% 
    rename(value = "C-DCHP") %>% 
    arrange(desc(value)) %>% 
    mutate(cdchp = 1:12) %>% 
    mutate(node = stringr::str_extract(name,
                                       pattern = "[:digit:]+")) %>%
    mutate(node = as.integer(node)) %>% 
    select(node, cdchp)
  
  m3_num <- m3_ranks %>% 
    rename(value = "C-MMHP") %>% 
    arrange(desc(value)) %>% 
    mutate(cmmhp = 1:12) %>% 
    mutate(node = stringr::str_extract(name,
                                       pattern = "[:digit:]+")) %>%
    mutate(node = as.integer(node)) %>% 
    select(node, cmmhp)

  isi_ranks <- tibble(node = expert_rank_10[[current_cohort]],
                      isi = 1:12)
  ###
  rank_df <- m1_num %>% 
    left_join(m2_num, by = "node") %>% 
    left_join(m3_num, by = "node") %>% 
    left_join(isi_ranks, by = "node")

  spear_cor <- cor(rank_df[,2:5], method = "spearman")
  # spear_corr_list[[current_cohort]] <- spear_cor
  
  curr_spear <- as_tibble(spear_cor) %>% 
    mutate(first = c("chp", "cdchp", "cmmhp", "isi")) %>%
    pivot_longer(cols = chp:isi) 
  
  spear_ind <- as_tibble(upper.tri(spear_cor)) %>% 
    pivot_longer(everything())
  
  curr_spear <- curr_spear %>% 
    bind_cols(spear_ind %>% 
                             rename(new_name = name, ind = value)) %>% 
    filter(ind == TRUE) %>% 
    select(first, name, value) %>% 
    rename(second = name) %>% 
    mutate(cohort = current_cohort)
  
  # %>% 
  # # filter(first != name) %>% 
  # # this removes ones which are actually identical
  # distinct(first, name, value, .keep_all = TRUE) %>% 
  # rename(second = name) %>% 
  # mutate(cohort = current_cohort)
  
  spear_corr_all <- spear_corr_all %>% 
    bind_rows(curr_spear)
}


spear_corr_all %>%
  left_join(cohort_summ, by = "cohort") %>% 
  filter(first == "chp") %>% 
  filter(second %in% c("cdchp", "cmmhp")) %>% 
  pivot_wider(id_cols = cohort, names_from = second, 
              values_from = c(value, act_perc)) %>% 
  select(cohort:act_perc_cdchp) %>% 
  rename(act_perc = act_perc_cdchp) %>% 
  mutate(corr_diff = value_cdchp - value_cmmhp) %>% 
  select(cohort, corr_diff, act_perc) %>% 
  ggplot(aes(corr_diff, act_perc)) +
  geom_point() +
  labs(y = "Percent fights Active", x = "Correlation Difference",
       subtitle = "Correlation difference between C-HP/C-DCHP and C-HP/C-MMHP")
# then join this with cohort summ and do the plot
```
