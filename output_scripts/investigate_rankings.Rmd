---
title: "Ranking Stability"
author: "Owen G. Ward"
date: '`r Sys.Date()`'
output:
  html_document:
    # toc: true
    # toc_depth: 2
    # toc_float: true
    number_sections: FALSE
    code_folding: hide
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, fig.height = 5, fig.width = 7,
  warning = FALSE, cache = TRUE
)

slides_plots <- FALSE
extra_plots <- FALSE


revision_plots <- TRUE
original_plots <- FALSE
### original plots for plots which are no longer needed, 
### revision plots are what required

current_cohort <- 5

# don't write to this path
data_path <- "../output/revisions/lapl_check/prior_check/"

func_dir <- "../lib/"

library(here)
# library(rstan)
library(cmdstanr)
Sys.setenv(LOCAL_CPPFLAGS = "-march=corei7 -mtune=corei7")
options(mc.cores = parallel::detectCores())
library(tidyverse)
library(R.utils)
library(RColorBrewer)
library(fields)
library(posterior)
library(bayesplot)
library(viridis)
library(here)
library(compete)
library(colorspace)
source(paste(func_dir, "naiveRankHierarchy.R", sep = ""))
source(paste(func_dir, "expertRankHierarchy.R", sep = ""))
source(paste(func_dir, "cleanData.R", sep = ""))
source(paste(func_dir, "prepareDataStan.R", sep = ""))
source(paste(func_dir, "inferLatentMmhp.R", sep = ""))
source(paste(func_dir, "plotUtil.R", sep = ""))
source(paste(func_dir, "mmhp.R", sep = ""))
source(paste(func_dir, "uniHawkes.R", sep = ""))
source(paste(func_dir, "simulatePrediction.R", sep = ""))
source(paste(func_dir, "myGlicko.R", sep = ""))
source(paste(func_dir, "matrixPlotParameter.R", sep = ""))
source(paste(func_dir, "residualStructureScore.R", sep = ""))
source(paste(func_dir, "drawIntensity.R", sep = ""))
source("https://gist.githubusercontent.com/jalapic/6ca3ece44bdcdc522bb735f183aa0ca0/raw/1a07f469eff08117121b6cbebcd22fb7569e3ee8/compete_extra.R")

cohort_names <- paste("cohort", c(9, 10, 12, 15, 16, 17, 18, 37, 38, 45),
                      sep = "")
cohort_short_names <- paste("C", c(9, 10, 12, 15, 16, 17, 18, 37, 38, 45),
                            sep = "")
cut_off <- 3
mice_number <- 12
col_df <- tibble(
  method = c(
    "I&SI", "AggRank", "DSNL", "Glicko", "I-MMHP",
    "C-HP", "C-DCHP", "True", "C-MMHP"
  ),
  cols = viridis(9)
)
theme_set(theme_minimal())
```



```{r load rankings, echo=FALSE, include=FALSE, results='hide', cache=TRUE}
full_data <- readRDS("../data/mice.RData")
# A=c9, B=c10, C=c12, D=c15, E=c16, F=c17, G=c18, H=c37, I=c38. J=c45

# Define the cohorts will be fitted
fit_cohorts <- c(1:10)
naive_rank_10 <- list()
expert_rank_10 <- list()
out <- captureOutput(for (curr_cohort in fit_cohorts) {
  naive_rank_10[[curr_cohort]] <-
    naiveRankHierarchy(full_data[[cohort_names[curr_cohort]]])
  expert_rank_10[[curr_cohort]] <-
    expertRankHierarchy(full_data[[cohort_names[curr_cohort]]])
})
```

```{r define_functions, eval=revision_plots, include=FALSE}
model1_fn <- list(alpha.fun = function(x, y, eta1, eta2, eta3) {
  return(eta1 * x * y * exp(-eta2 * abs(x - y)) / (1 +
    exp(-eta3 * (x - y))))
})

model3_fn <- list(
  alpha.fun = function(x, y, eta1, eta2) {
    return(eta1 * x * y * exp(-eta2 * abs(x - y)))
  },
  q1.fun = function(x, y, eta3) {
    return(exp(-eta3 * x))
  },
  q0.fun = function(x, y, eta3) {
    return(exp(-eta3 * y))
  }
)
```


# Ranking and Events

We first modify the priors from the C-MMHP model which leads to
much improved MCMC performance.

We want to look at the relationship between the inferred variability
of the ranking and the number of interactions a given animal is involved in.

We plot the inferred ranks arranged by decreasing number 
of total interactions for all 4 of the comparison models, as in Fig6a.

```{r plot-rank-total-interactions, eval=FALSE}
for(current_cohort in 1:10) {
  clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
             ))
  total_inter <- rowSums(clean_data$N_count) + colSums(clean_data$N_count)
  f_ranks <- paste("f[", order(total_inter, decreasing = TRUE),
                   "]", sep = "")
  f_draws <- sim_cohort_mmhp %>% select(starts_with("f")) %>% 
  pivot_longer(everything())
  f_draws$name <- factor(f_draws$name, levels = f_ranks)
  plot_f <- f_draws %>% 
  ggplot(aes(name, value)) +
  geom_boxplot() +
  labs(title = paste("Cohort ", current_cohort, sep = ""),
       subtitle = "Ordered by total interactions")
  print(plot_f)
}
```


```{r all-4-models, warning=FALSE}
for(current_cohort in 1:10) {
  clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
             ))
  load(paste(data_path, cohort_names[current_cohort],
    "/agg_rank_stan_result_", cohort_names[current_cohort],
    ".RData",
    sep = ""
  ))
  load(paste(data_path, cohort_names[current_cohort],
    "/cohort_hp_stan_result_", cohort_names[current_cohort],
    ".RData",
    sep = ""
  ))
  load(paste(data_path, cohort_names[current_cohort],
    "/cohort_dchp_stan_result_", cohort_names[current_cohort],
    ".RData",
    sep = ""
  ))
  total_inter <- rowSums(clean_data$N_count) + colSums(clean_data$N_count)
  
  
  no_method <- 4
  plot_latent_df <- data.frame(
    Methods = rep(1:no_method, each = 1000 * mice_number),
    Mice = rep(rep(1:mice_number, each = 1000), no_method),
    force = rep(0, 1000 * mice_number * no_method)
  )
  ## agg
  x_draws <- sim_agg_rank %>% select(starts_with("x"))
  plot_latent_df$force[(1:(1000 * mice_number))] <-
    as.vector(as.matrix(x_draws))
  
  ## M1
  f_draws <- sim_cohort_hp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) +
                         1000 * mice_number] <-
    as.vector(as.matrix(f_draws))
  
  ## M2
  f_draws <- sim_cohort_dchp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) + 
                         2000 * mice_number] <-
    as.vector(as.matrix(f_draws))
  
  ## M3
  f_draws <- sim_cohort_mmhp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) + 
                         3000 * mice_number] <-
    as.vector(as.matrix(f_draws))
  
  plot_latent_df$Mice <- factor(plot_latent_df$Mice,
    levels = order(total_inter, decreasing = TRUE)
  )
  plot_latent_df$Method <- factor(plot_latent_df$Method,
    labels = c("AggRanking", "C-HP", "C-DCHP", "C-MMHP")
  )
  plot_cols <- col_df %>%
  filter(method %in% c(
    "AggRank", "C-HP",
    "C-DCHP", "C-MMHP"
  )) %>%
  pull(cols)


  p1 <- ggplot(plot_latent_df, aes(x = Mice, y = force, fill = Method)) +
    geom_boxplot(alpha = 0.7) +
    scale_fill_manual(values = plot_cols) +
    ggtitle("(a)") +
    theme_bw() +
    theme(
      plot.title = element_text(size = 22, hjust = 0.5, face = "bold"),
      text = element_text(size = 20),
      axis.text.x = element_text(size = 10),
      legend.position = "none"
    ) +
    facet_grid(cols = vars(Method)) +
    xlab("Mice (ranked by total interactions)") +
    ylab("Latent rank") + 
    labs(title = paste("Cohort ", current_cohort, sep = ""))
  print(p1)
}

```

Similarly, here are the corresponding plots with the animals ranked by 
I&SI score instead.

```{r isi-ranks, warning=FALSE, eval=FALSE}
for(current_cohort in 1:10) {
  clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
             ))
  total_inter <- rowSums(clean_data$N_count) + colSums(clean_data$N_count)
  f_ranks <- paste("f[", expert_rank_10[[current_cohort]],
                   "]", sep = "")
  f_draws <- sim_cohort_mmhp %>% select(starts_with("f")) %>% 
  pivot_longer(everything())
  f_draws$name <- factor(f_draws$name, levels = f_ranks)
  plot_f <- f_draws %>% 
  ggplot(aes(name, value)) +
  geom_boxplot() +
  labs(title = paste("Cohort ", current_cohort, sep = ""),
       subtitle = "Ordered by I&SI score")
  print(plot_f)
}

```

```{r ranked-by-isi}
for(current_cohort in 1:10) {
  clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
             ))
  load(paste(data_path, cohort_names[current_cohort],
    "/agg_rank_stan_result_", cohort_names[current_cohort],
    ".RData",
    sep = ""
  ))
  load(paste(data_path, cohort_names[current_cohort],
    "/cohort_hp_stan_result_", cohort_names[current_cohort],
    ".RData",
    sep = ""
  ))
  load(paste(data_path, cohort_names[current_cohort],
    "/cohort_dchp_stan_result_", cohort_names[current_cohort],
    ".RData",
    sep = ""
  ))
  total_inter <- rowSums(clean_data$N_count) + colSums(clean_data$N_count)
  
  
  no_method <- 4
  plot_latent_df <- data.frame(
    Methods = rep(1:no_method, each = 1000 * mice_number),
    Mice = rep(rep(1:mice_number, each = 1000), no_method),
    force = rep(0, 1000 * mice_number * no_method)
  )
  ## agg
  x_draws <- sim_agg_rank %>% select(starts_with("x"))
  plot_latent_df$force[(1:(1000 * mice_number))] <-
    as.vector(as.matrix(x_draws))
  
  ## M1
  f_draws <- sim_cohort_hp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) +
                         1000 * mice_number] <-
    as.vector(as.matrix(f_draws))
  
  ## M2
  f_draws <- sim_cohort_dchp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) + 
                         2000 * mice_number] <-
    as.vector(as.matrix(f_draws))
  
  ## M3
  f_draws <- sim_cohort_mmhp %>% select(starts_with("f"))
  plot_latent_df$force[(1:(1000 * mice_number)) + 
                         3000 * mice_number] <-
    as.vector(as.matrix(f_draws))
  
  plot_latent_df$Mice <- factor(plot_latent_df$Mice,
    levels = expert_rank_10[[current_cohort]]
  )
  plot_latent_df$Method <- factor(plot_latent_df$Method,
    labels = c("AggRanking", "C-HP", "C-DCHP", "C-MMHP")
  )
  plot_cols <- col_df %>%
  filter(method %in% c(
    "AggRank", "C-HP",
    "C-DCHP", "C-MMHP"
  )) %>%
  pull(cols)


  p1 <- ggplot(plot_latent_df, aes(x = Mice, y = force, fill = Method)) +
    geom_boxplot(alpha = 0.7) +
    scale_fill_manual(values = plot_cols) +
    ggtitle("(a)") +
    theme_bw() +
    theme(
      plot.title = element_text(size = 22, hjust = 0.5, face = "bold"),
      text = element_text(size = 20),
      axis.text.x = element_text(size = 10),
      legend.position = "none"
    ) +
    facet_grid(cols = vars(Method)) +
    xlab("Mice (ranked by I&SI)") +
    ylab("Latent rank") + 
    labs(title = paste("Cohort ", current_cohort, sep = ""))
  print(p1)
}


```

Cohort 3 win loss

```{r c3-win-loss}
current_cohort <- 3
clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])

clean_data$N_count

load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
             ))

gamma_draws <- sim_cohort_mmhp %>% 
  select(starts_with("gamma")) %>% 
  pivot_longer(everything()) 

gamma_draws$name <- factor(gamma_draws$name, 
                           levels = paste("gamma[", 1:12, "]", sep = ""))

gamma_draws %>% 
  ggplot(aes(name, value)) + 
  geom_boxplot()


zeta_draws <- sim_cohort_mmhp %>% 
  select(starts_with("zeta")) %>% 
  pivot_longer(everything()) 

zeta_draws$name <- factor(zeta_draws$name, 
                           levels = paste("zeta[", 1:12, "]", sep = ""))

zeta_draws %>% 
  ggplot(aes(name, value)) + 
  geom_boxplot()

f_draws <- sim_cohort_mmhp %>% 
  select(starts_with("f")) %>% 
  pivot_longer(everything()) %>% 
  group_by(name) %>% 
  summarise(med = median(value)) %>% 
  arrange(-med)

f_draws %>% pull(name) 

cmmhp_ranks <- c(10, 12, 7, 6, 3, 8, 2, 4, 1, 9, 11, 5)
clean_data$N_count[cmmhp_ranks, cmmhp_ranks]

c3_count <- clean_data$N_count
names(c3_count) <- 1:12
rownames(c3_count) <- 1:12
colnames(c3_count) <- 1:12
isi98(c3_count)
isi98(c3_count[cmmhp_ranks, cmmhp_ranks])
```


## Plot Omega Lambda and f draws

```{r plot-omega-lambda, message=FALSE}
for(current_cohort in 1:10) {
  clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
             ))
  fit_draws <- as_draws_array(sim_cohort_mmhp)
  plot1 <- mcmc_hist(fit_draws, pars = "w_lambda") +
    labs(paste("Cohort ", current_cohort, sep = ""))
  print(plot1)
}
```


# Compare rankings with/without eta_3


```{r plot-rankings-both-models, message=FALSE}
# data_path
other_data_path <- "../output/revisions/lapl_check/ident_check/"

for(current_cohort in 1:10) {
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
             ))
  sim1 <- sim_cohort_mmhp
  load(paste(other_data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
             ))
  sim2 <- sim_cohort_mmhp
  
  all_data <- sim1 %>%
    select(starts_with("f")) %>% 
    pivot_longer(everything()) %>% 
    mutate(model = "with eta3") %>% 
    bind_rows(sim2 %>% select(starts_with("f")) %>% 
                pivot_longer(everything()) %>% 
                mutate(model = "without"))
  all_data$model <- factor(all_data$model)
  comp_plot <- ggplot(all_data, aes(name, value, fill = model)) +
    geom_boxplot() +
    labs(title = paste("Cohort ", current_cohort, sep = ""),
         subtitle = "Removing eta3",
         y = "Latent Rankings")
  print(comp_plot)
  
  all_data %>% group_by(name, model) %>% 
    summarise(model_mean = mean(value), 
              model_sd = sd(value))
    
  ## same for gamma,
  all_data <- sim1 %>%
    select(contains("eta") | starts_with("w_lam")) %>% 
    pivot_longer(everything()) %>% 
    mutate(model = "with eta1") %>% 
    bind_rows(sim2 %>% select(contains("eta") | starts_with("w_lam")) %>% 
                pivot_longer(everything()) %>% 
                mutate(model = "without"))
  all_data$model <- factor(all_data$model)
  comp_plot <- ggplot(all_data, aes(name, value, fill = model)) +
    geom_boxplot() +
    labs(title = paste("Cohort ", current_cohort, sep = ""),
         subtitle = "Comparison removing eta3", y = "Other params") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  print(comp_plot)
  
  
  ###
  all_data <- sim1 %>%
    select(starts_with("gamma")) %>% 
    pivot_longer(everything()) %>% 
    mutate(model = "with eta3") %>% 
    bind_rows(sim2 %>% select(starts_with("gamma")) %>% 
                pivot_longer(everything()) %>% 
                mutate(model = "without"))
  all_data$model <- factor(all_data$model)
  comp_plot <- ggplot(all_data, aes(name, value, fill = model)) +
    geom_boxplot() +
    labs(title = paste("Cohort ", current_cohort, sep = ""),
         subtitle = "Comparison removing eta3", y = "Out Degree") +
  print(comp_plot)
  
  
}

```


# Compare rankings with/without eta_1


```{r plot-rankings-both-models, message=FALSE}
# data_path
other_data_path <- "../output/revisions/lapl_check/ident_check_no_eta1/"

for(current_cohort in 1:10) {
  load(paste(data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
             ))
  sim1 <- sim_cohort_mmhp
  load(paste(other_data_path,
             cohort_names[current_cohort],
             "/cohort_mmhp_stan_result_",
             cohort_names[current_cohort],
             ".RData",
             sep = ""
             ))
  sim2 <- sim_cohort_mmhp
  
  all_data <- sim1 %>%
    select(starts_with("f")) %>% 
    pivot_longer(everything()) %>% 
    mutate(model = "with eta1") %>% 
    bind_rows(sim2 %>% select(starts_with("f")) %>% 
                pivot_longer(everything()) %>% 
                mutate(model = "without"))
  all_data$model <- factor(all_data$model)
  comp_plot <- ggplot(all_data, aes(name, value, fill = model)) +
    geom_boxplot() +
    labs("Rankings across models")
  print(comp_plot)
  
  all_data %>% group_by(name, model) %>% 
    summarise(model_mean = mean(value), 
              model_sd = sd(value))
    
  ## same for gamma,
  all_data <- sim1 %>%
    select(contains("eta") | starts_with("w_lam")) %>% 
    pivot_longer(everything()) %>% 
    mutate(model = "with eta1") %>% 
    bind_rows(sim2 %>% select(contains("eta") | starts_with("w_lam")) %>% 
                pivot_longer(everything()) %>% 
                mutate(model = "without"))
  all_data$model <- factor(all_data$model)
  comp_plot <- ggplot(all_data, aes(name, value, fill = model)) +
    geom_boxplot() +
    labs(title = paste("Cohort ", current_cohort, sep = ""),
         subtitle = "Comparison removing eta1", y = "Eta params") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  print(comp_plot)
  
  ###
  all_data <- sim1 %>%
    select(starts_with("gamma")) %>% 
    pivot_longer(everything()) %>% 
    mutate(model = "with eta1") %>% 
    bind_rows(sim2 %>% select(starts_with("gamma")) %>% 
                pivot_longer(everything()) %>% 
                mutate(model = "without"))
  all_data$model <- factor(all_data$model)
  comp_plot <- ggplot(all_data, aes(name, value, fill = model)) +
    geom_boxplot() +
    labs(title = paste("Cohort ", current_cohort, sep = ""),
         subtitle = "Comparison removing eta1", y = "Out Degree")
  print(comp_plot)
  
  
}

```


# Other Paper plots

```{r fig-3b}
current_cohort <- 5

m1_pr <- readRDS(paste(data_path, cohort_names[current_cohort],
  "/chp_pr_matrix_", cohort_names[current_cohort],
  ".RDS",
  sep = ""
))

m2_pr <- readRDS(paste(data_path, cohort_names[current_cohort],
  "/dchp_pr_matrix_", cohort_names[current_cohort],
  ".RDS",
  sep = ""
))

m3_pr <- readRDS(paste(data_path, cohort_names[current_cohort],
  "/cmmhp_pr_matrix_", cohort_names[current_cohort],
  ".RDS",
  sep = ""
))

indep_pr <- readRDS(paste(data_path, cohort_names[current_cohort],
  "/immhp_pr_matrix_", cohort_names[current_cohort],
  ".RDS",
  sep = ""
))

matrix_lst_plot <- list(
  m1_pr[
    rev(expert_rank_10[[current_cohort]]),
    expert_rank_10[[current_cohort]]
  ],
  m2_pr[
    rev(expert_rank_10[[current_cohort]]),
    expert_rank_10[[current_cohort]]
  ]
  ,
  m3_pr[
    rev(expert_rank_10[[current_cohort]]),
    expert_rank_10[[current_cohort]]
  ],
  indep_pr[
    rev(expert_rank_10[[current_cohort]]),
    expert_rank_10[[current_cohort]]
  ]
)
# cat("Cohort ",current_cohort,"\n",sep="")
myMultiMatrixPlot(
  X = matrix_lst_plot, no_matrix = 4, n_row = 2,
  xLabels = expert_rank_10[[current_cohort]],
  yLabels = rev(expert_rank_10[[current_cohort]]),
  min = -80, max = 80, axis_cex = 2, title_cex = 1.8,
  colorPalette = "RdBu", if.emp = FALSE,
  # legend.mar=c(0.5,.5,0.5,0.5),
  title_lst = list("C-HP", "C-DCHP", "C-MMHP", "I-MMHP"),
  # title_lst = list("I-MMHP"),
  col_axis = c(-80, -40, 0, 40, 80), 
  fake_matrix = FALSE,
  matrix.mar = c(2.5, 2.5, 2.5, 1)
)
mtext(text = "(b)",
      side = 3,
      line = 0.5,
      outer = TRUE,
      cex = 2.5,
      font = 2)

```


```{r fig-7a}
load("../output/revisions/lapl_check/prior_check/plot_N_predict_revision.RData")
current_cohort <- 5 # cohort 1 looks worse than rest

temp_plot_df <- predict_day_mae_df_lst[[current_cohort]]
temp_plot_df$method <- factor(temp_plot_df$method,
  levels = c("mmhp", "dsnl", "m1", "m2", "m3"),
  labels = c("I-MMHP", "DSNL", "C-HP", "C-DCHP", "C-MMHP")
)
temp_plot_df$day <- factor(temp_plot_df$day)
# png(paste(plot_path,"real_predict_N_one_cohort.png",sep=""),
# width=600,height=300)

plot_cols_pred <- col_df %>%
  filter(method %in% levels(temp_plot_df$method)) %>%
  arrange(factor(method, levels = c(
    "I-MMHP", "DSNL",
    "C-HP", "C-DCHP", "C-MMHP"
  ))) %>%
  pull(cols)

p3 <- temp_plot_df %>%
  rowwise() %>%
  # mutate(norm = min(norm,60)) %>%
  # rename(Method = method) %>%
  ggplot(aes(x = method, y = mae, fill = method)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_manual(values = plot_cols_pred) +
  ggtitle("(a)") +
  theme_bw() +
  theme(
    plot.title = element_text(size = 22, hjust = 0.5, face = "bold"),
    text = element_text(size = 20),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "right"
  ) +
  facet_grid(cols = vars(day)) +
  xlab("Prediction horizon (day)") +
  ylab("MAE") +
  ylim(0, 5) + # aren't infinite but >150 and <200
  NULL
p3 + labs(fill = "Method", title = "Single Cohort")


```
```{r fig-7b}
load("../output/revisions/lapl_check/prior_check/plot_N_predict_revision.RData")

all_cohort_box <- all_cohort_mae_df

all_cohort_box$method <- factor(all_cohort_box$method,
  levels = c("mmhp", "dsnl", "m1", "m2", "m3"),
  labels = c(
    "I-MMHP", "DSNL",
    "C-HP", "C-DCHP",
    "C-MMHP"
  )
)
all_cohort_box$day <- factor(all_cohort_box$day)


plot_cols_pred <- col_df %>%
  filter(method %in% levels(all_cohort_box$method)) %>%
  arrange(factor(method, levels = c(
    "I-MMHP", "DSNL",
    "C-HP", "C-DCHP", "C-MMHP"
  ))) %>%
  pull(cols)

all_cohort_box %>%
  ggplot(aes(x = method, y = norm, fill = method)) +
  # facet_grid(cols = vars(day)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_manual(values = plot_cols_pred) +
  ggtitle("(a)") +
  theme_bw() +
  theme(
    plot.title = element_text(
      size = 22,
      hjust = 0.5, face = "bold"
    ),
    text = element_text(size = 20),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "right"
  ) +
  facet_grid(cols = vars(day)) +
  # guides(color=guide_legend(title="Method")) +
  xlab("Prediction horizon (day)") +
  ylab("MAE") +
  labs(fill = "Method") +
  # ylim(0, 80) +
  NULL


```

# Look at the inferred latent states


```{r process-cohort}
current_cohort <- 3

clean_data <- cleanData(full_data[[cohort_names[current_cohort]]])
return_df <- cleanObservationPeriod(current_cohort,
  raw_df =
    full_data[[cohort_names[current_cohort]]],
  clean_data
)
unique_pairs_df <- return_df %>%
  group_by(initiator, recipient) %>%
  dplyr::summarize(
    count = n(),
    observe = list(observe.id),
    observe.length = list(observe.time),
    no.events = list(no.events)
  )
unique_observe_win <- unique(return_df[, c("observe.id", "observe.time")])

mean_states <- function(df) {
  return(apply(df, 1, mean))
}

load(paste(data_path, cohort_names[current_cohort],
  "/cmmhp_est_zt_", cohort_names[current_cohort],
  ".RData",
  sep = ""
))



num_pairs <- nrow(unique_pairs_df)
pair_result <- vector(mode = "list", length = num_pairs)

for(i in seq_along(1:num_pairs)) {
  # if(i != 19) {
    # print(i)
    pair_result[[i]] <- interpolation_array_list[[i]] %>%
    map(~mean_states((.x))) %>%
    set_names(paste0("window_", 1:nrow(unique_observe_win))) %>%
    as_tibble()
  # }
}

rm(interpolation_array_list)

```


```{r plot-function}
plot_window <- function(init, rec, unique_observe_win, pair_result) {
  res_state_tibb <- tibble()
  res_event_tibb <- tibble()
  pair <- unique_pairs_df %>%
            ungroup() %>%
            mutate(index = row_number()) %>%
            filter(initiator == init & recipient == rec) %>%
            pull(index)
  if(length(pair) == 0) {
    stop("No interactions")
  }
  for(window in 1:nrow(unique_observe_win)) {
    state_vec <- pair_result[[pair]][, window]
    state_vec <- state_vec %>% pull(names(state_vec))
    length_wind <- unique_observe_win$observe.time[window]
    init <- unique_pairs_df$initiator[pair]
    rec <- unique_pairs_df$recipient[pair]
    events <- return_df %>%
      filter(initiator == init) %>%
      filter(recipient == rec) %>%
      filter(observe.id == window)
    if(nrow(events) > 0 ) {
      event_times <- unlist(events$event.times)
      event_tibb <- tibble(x = event_times, y = 0, wind = window)
      res_event_tibb <- res_event_tibb %>%
        bind_rows(event_tibb)

      state_tibb <- tibble(x = seq(from = 0,
                                   to = length_wind,
                                   length.out = 500),
                           mean_state = state_vec,
                           wind = window)
      res_state_tibb <- res_state_tibb %>%
      bind_rows(state_tibb)
    }
  }
  ### could do a facet wrap by window!
  plt <- res_state_tibb %>%
  ggplot(aes(x, mean_state)) +
  geom_line(aes(colour = "Mean State")) +
  geom_point(data = res_event_tibb, mapping = aes(x,y)) +
  facet_wrap(~wind, scales = "free_x") +
  scale_y_continuous(breaks = c(0, 1)) +
  ylim(c(0,1)) +
  # scale_x_continuous(breaks = c(1, 2)) +
  theme(legend.title = element_blank(), axis.text.x = element_blank()) +
  labs(x = "Time", y = "Latent State",
       title = paste("From", init, "to", rec))
  print(plt)
}

```

Then we can plot some pairs from this cohort.

```{r plot-from-5, message=FALSE}
plot_window(5, 1, unique_observe_win, pair_result)
plot_window(5, 2, unique_observe_win, pair_result)
plot_window(5, 3, unique_observe_win, pair_result)
plot_window(5, 4, unique_observe_win, pair_result)
plot_window(5, 6, unique_observe_win, pair_result)
plot_window(5, 7, unique_observe_win, pair_result)
plot_window(5, 8, unique_observe_win, pair_result)
plot_window(5, 9, unique_observe_win, pair_result)
plot_window(5, 10, unique_observe_win, pair_result)
plot_window(5, 11, unique_observe_win, pair_result)
plot_window(5, 12, unique_observe_win, pair_result)
```


```{r to-5}
# plot_window(1, 5, unique_observe_win, pair_result)
plot_window(2, 5, unique_observe_win, pair_result)
plot_window(3, 5, unique_observe_win, pair_result)
plot_window(4, 5, unique_observe_win, pair_result)
plot_window(6, 5, unique_observe_win, pair_result)
plot_window(7, 5, unique_observe_win, pair_result)
plot_window(8, 5, unique_observe_win, pair_result)
# plot_window(9, 5, unique_observe_win, pair_result)
plot_window(10, 5, unique_observe_win, pair_result)
# plot_window(11, 5, unique_observe_win, pair_result)
# plot_window(12, 5, unique_observe_win, pair_result)
```






<!-- ```{r from-12, eval=FALSE} -->
<!-- ## make sure correct return_df loaded here -->
<!-- plot_window(8, 1) -->
<!-- plot_window(8, 2) -->
<!-- plot_window(8, 3) -->
<!-- plot_window(8, 4) -->
<!-- plot_window(8, 5) -->
<!-- plot_window(8, 6) -->
<!-- plot_window(8, 7) -->
<!-- # plot_window(8, 8) -->
<!-- plot_window(8, 9) -->
<!-- plot_window(8, 10) -->
<!-- plot_window(8, 11) -->
<!-- plot_window(8, 12) -->
<!-- ``` -->

<!-- ```{r to-animal-12, eval=FALSE} -->
<!-- # # plot_window(1, 12) -->
<!-- # # plot_window(2, 12) -->
<!-- # plot_window(3, 12) -->
<!-- # plot_window(4, 12) -->
<!-- # plot_window(5, 12) -->
<!-- # # plot_window(6, 12) -->
<!-- # # plot_window(7, 12) -->
<!-- # plot_window(8, 12) -->
<!-- # plot_window(9, 12) -->
<!-- # plot_window(10, 12) -->
<!-- # plot_window(11, 12) -->

<!-- plot_window(2, 9, unique_observe_win) -->
<!-- plot_window(2, 7, unique_observe_win) -->
<!-- plot_window(2, 8, unique_observe_win) -->
<!-- plot_window(7, 8, unique_observe_win) -->
<!-- ``` -->


<!-- ## Active/Inactive -->

<!-- ```{r compute-active-in, eval=FALSE} -->
<!-- current_cohort <- 6 -->
<!-- load(paste(data_path, cohort_names[current_cohort], -->
<!--   "/cmmhp_est_zt_", cohort_names[current_cohort], -->
<!--   ".RData", -->
<!--   sep = "" -->
<!-- )) -->


<!-- total_event_array <- array(0, -->
<!--                            dim = c(mice_number, mice_number, -->
<!--                                    max(return_df$observe.id))) -->
<!-- active_event_array <- array(0, -->
<!--                             dim = c(mice_number, mice_number, -->
<!--                                     max(return_df$observe.id))) -->

<!-- for (i in 1:mice_number) { -->
<!--   for (j in 1:mice_number) { -->
<!--     if(i != j) { -->
<!--       pair <- which(unique_pairs_df$initiator == i &  -->
<!--                       unique_pairs_df$recipient == j) -->
<!--       if (length(pair) > 0) { -->
<!--         current_window_vec <- unique_pairs_df$observe[[pair]] -->
<!--         for (cur_win in current_window_vec) { -->
<!--           row_indicator <- (return_df$initiator == i) & -->
<!--             (return_df$recipient == j) & -->
<!--             (return_df$observe.id == cur_win) -->
<!--           total_event_array[i, j, cur_win] <- length(return_df[row_indicator, -->
<!--                                                             "event.times"][[1]]) -->
<!--           active_event_array[i, j, cur_win] <- sum(apply(2 - -->
<!--                                            state_array_list[[pair]][[cur_win]], -->
<!--                                            1, mean) > 0.5) -->
<!--         } -->
<!--       } -->
<!--     } -->
<!--   } -->
<!-- } -->

<!-- total_matrix <- apply(total_event_array, c(1,2), sum) -->
<!-- active_matrix <- apply(active_event_array, c(1,2), sum) -->

<!-- inact_matrix <- total_matrix - active_matrix -->

<!-- rm(interpolation_array_list) -->

<!-- ``` -->


<!-- ## Variance of f for no fights -->

<!-- ```{r var-f, eval=FALSE} -->
<!-- data_path <- "../output/revisions/lapl_check/" -->
<!-- current_cohort <- 6 -->
<!-- ## good for 4,8,9 -->
<!-- ## ok for 2 -->
<!-- ## bad for 1, 10 -->
<!-- load(paste(data_path, cohort_names[current_cohort], -->
<!--   "/cohort_mmhp_stan_result_", cohort_names[current_cohort], -->
<!--   ".RData", -->
<!--   sep = "" -->
<!-- )) -->

<!-- clean_data <- cleanData(full_data[[cohort_names[current_cohort]]]) -->
<!-- return_df <- cleanObservationPeriod(current_cohort, -->
<!--       raw_df = full_data[[cohort_names[current_cohort]]], -->
<!--       clean_data) -->
<!-- sim_cohort_mmhp -->

<!-- sim_cohort_mmhp %>% select(starts_with("f")) %>%  -->
<!--   pivot_longer(everything()) %>%  -->
<!--   ggplot(aes(name, value)) + -->
<!--   geom_boxplot() -->

<!-- rowSums(clean_data$N_count) + colSums(clean_data$N_count) -->

<!-- sim_cohort_mmhp %>% select(starts_with("f")) %>%  -->
<!--   pivot_longer(everything()) %>%  -->
<!--   group_by(name) %>%  -->
<!--   summarise(sd = sd(value)) %>%  -->
<!--   arrange(desc(sd)) %>%  -->
<!--   print(n = 12) -->


<!-- ``` -->

<!-- ```{r investigate-stan-fits, eval=FALSE} -->
<!-- ## rerunning with ensuring that delta is not fixed. -->
<!-- pri_data_path <- "../output/revisions/lapl_check/prior/" -->
<!-- current_cohort <- 9 -->
<!-- ## good for 4,8,9 -->
<!-- ## ok for 2 -->
<!-- ## bad for 1, 10 -->
<!-- load(paste(pri_data_path, cohort_names[current_cohort], -->
<!--   "/cohort_mmhp_stan_result_", cohort_names[current_cohort], -->
<!--   ".RData", -->
<!--   sep = "" -->
<!-- )) -->

<!-- hist(sim_cohort_mmhp$w_lambda) -->
<!-- # table(sim_cohort_mmhp$w_lambda) -->

<!-- ### convert to "draws" object, compute rhats -->
<!-- fit_draws <- as_draws_array(sim_cohort_mmhp) -->

<!-- mcmc_trace(fit_draws, pars = c("w_lambda", "beta", "gamma[1]")) -->

<!-- rhat(fit_draws[ , ,"f[1]"]) -->

<!-- rhat_fit <- apply(fit_draws, 3, rhat) -->
<!-- summary(rhat_fit) -->
<!-- ``` -->


<!-- ### What is difference between cohort 4 and 5/6 -->

<!-- ```{r cohort-stats, eval=FALSE} -->
<!-- clean_data_2 <- cleanData(full_data[[cohort_names[2]]]) -->
<!-- clean_data_4 <- cleanData(full_data[[cohort_names[4]]]) -->
<!-- clean_data_6 <- cleanData(full_data[[cohort_names[6]]]) -->
<!-- clean_data_1 <- cleanData(full_data[[cohort_names[1]]]) -->
<!-- clean_data_10 <- cleanData(full_data[[cohort_names[10]]]) -->
<!-- ``` -->


<!-- ```{r, message=FALSE, eval=FALSE} -->
<!-- for(current_cohort in 1:10) { -->
<!--   print(current_cohort) -->
<!--    clean_data <- cleanData(full_data[[cohort_names[current_cohort]]]) -->
<!--     return_df <- cleanObservationPeriod(current_cohort, -->
<!--       raw_df = -->
<!--         full_data[[cohort_names[current_cohort]]], -->
<!--       clean_data -->
<!--     ) -->
<!--     print(sum(clean_data$N_count)) -->
<!--     unique_pairs_df <- return_df %>% -->
<!--       group_by(initiator, recipient) %>% -->
<!--       dplyr::summarize( -->
<!--         count = n(), -->
<!--         observe = list(observe.id), -->
<!--         observe.length = list(observe.time), -->
<!--         no.events = list(no.events) -->
<!--       ) -->
<!--     unique_observe_win <- unique(return_df[, c("observe.id", "observe.time")]) -->
<!--     print(nrow(unique_observe_win)) -->
<!--     print(sum(unique_observe_win$observe.time)) -->
<!--     print(summary(unique_pairs_df$count)) -->
<!--     cat("-------\n") -->
<!-- } -->
<!-- ``` -->

<!-- ## Bayesplot -->

<!-- ```{r specific-cohort, eval=FALSE} -->
<!-- current_cohort <- 4 -->
<!-- load(paste(pri_data_path, cohort_names[current_cohort], -->
<!--   "/cohort_mmhp_stan_result_", cohort_names[current_cohort], -->
<!--   ".RData", -->
<!--   sep = "" -->
<!-- )) -->


<!-- fit_draws <- as_draws_array(sim_cohort_mmhp) -->
<!-- ``` -->


<!-- ```{r, eval=FALSE} -->
<!-- mcmc_pairs(fit_draws, pars = c("eta_1", "eta_2", "eta_3", "beta")) -->

<!-- mcmc_trace(fit_draws, pars = c("eta_1", "eta_2", "eta_3", "beta")) -->

<!-- mcmc_pairs(fit_draws, pars = c("beta", "eta_3"),  -->
<!--              diag_fun = "dens", off_diag_fun = "hex", -->
<!--              condition = pairs_condition(chains = list(2, c(1,3,4)))) -->

<!-- ``` -->



<!-- ## Check Priors -->

<!-- ```{r normal-priors, eval=FALSE} -->


<!-- pri_data_path <- "../output/revisions/lapl_check/prior_check/" -->


<!-- for(current_cohort in 1:10) { -->
<!--   print(current_cohort) -->
<!--   load(paste(pri_data_path, cohort_names[current_cohort], -->
<!--   "/cohort_mmhp_stan_result_", cohort_names[current_cohort], -->
<!--   ".RData", -->
<!--   sep = "" -->
<!--   )) -->
<!--   fit_draws <- as_draws_array(sim_cohort_mmhp) -->
<!--   rhat_fit <- apply(fit_draws, 3, posterior::rhat) -->
<!--   print(summary(rhat_fit)) -->
<!--   print(mcmc_trace(fit_draws,  -->
<!--              pars = c("eta_1", "eta_2", "eta_3", "beta"))) -->
<!--   cat("-----\n") -->
<!-- } -->

<!-- mcmc_pairs(fit_draws, pars = c("eta_1", "eta_2", "eta_3", "beta")) -->

<!-- ``` -->


<!-- ## check rankings against isi score this data -->

<!-- ```{r label, eval=FALSE} -->
<!-- for(current_cohort in 1:10) { -->
<!--   print(current_cohort) -->
<!--   load(paste(pri_data_path, cohort_names[current_cohort], -->
<!--   "/cohort_mmhp_stan_result_", cohort_names[current_cohort], -->
<!--   ".RData", -->
<!--   sep = "" -->
<!--   )) -->
<!--   clean_data <- cleanData(full_data[[cohort_names[current_cohort]]]) -->
<!--   fit_draws <- as_draws_array(sim_cohort_mmhp) -->
<!--   f_draws <- sim_cohort_mmhp %>% select(starts_with("f")) %>%  -->
<!--   pivot_longer(everything()) -->
<!--   f_draws$name <- factor(f_draws$name, levels = paste("f[", -->
<!--                                       expert_rank_10[[current_cohort]], -->
<!--                                       "]", sep = "")) -->
<!--   f_draws %>%  -->
<!--   ggplot(aes(name, value)) + -->
<!--   geom_boxplot() -->

<!--   rowSums(clean_data$N_count) + colSums(clean_data$N_count) -->

<!--   sim_cohort_mmhp %>% select(starts_with("f")) %>%  -->
<!--     pivot_longer(everything()) %>%  -->
<!--     group_by(name) %>%  -->
<!--     summarise(sd = sd(value)) %>%  -->
<!--     arrange(desc(sd)) %>%  -->
<!--     print(n = 12) -->

<!--   cat("-----\n") -->
<!-- } -->
<!-- ``` -->
